# 11. Smart Contract Operations ‚öôÔ∏è

The $\text{IPFS-Sats}$ smart contract serves as the executive engine of the Per-Content $\text{DAO}$, automating economic compliance and governance enforcement in a trustless environment. All contract logic is driven by the immutable parameters defined in the $\text{DAO}$ Configuration Object (Section 10.3).

---

## 11.1 Yield Distribution

The smart contract manages the automated, **non-custodial disbursement** of all revenue generated by the asset (sale, usage fees, royalties), adhering strictly to the **Fork Economics** model.

### Calculation Methodology

All incoming revenue is immediately and atomically split into three primary, rule-based buckets:

1.  **Upstream Royalty:** Distributed to the Parent $\text{CID}$'s wallet address(es) as defined by the **`upstream\_percentage`** in the `fork\_provenance`. This enforces the economic rights of previous creators (Section 8.2).
2.  **DAO Stake/Creator Share:** Distributed to the current content $\text{DAO}$'s wallet address (the wallet_address in 10.1) according to the **`creator\_percentage`**.
3.  **Persistence Fee ($\text{LYW}$ Top-up):** A small, pre-defined percentage is diverted to the **Locked Yield Wallet ($\text{LYW}$)** to ensure long-term content persistence funding.

### Payment Triggers and Reporting

Payments are typically triggered by specific Layer 2 ($\text{Lightning}$) events, enabling immediate and low-cost settlement:

* **Triggers:** Include **On-Demand Sale** (direct payment upon verification), **Subscription Settlement** (periodic payment for accrued usage), and **Escrow Release** (payment upon verification of licensing conditions).
* **Reporting:** All distribution events are recorded on an immutable ledger linked via a $\text{CID}$ (e.g., an $\text{IPLD}$ structure) and maintained by the smart contract. This provides a verifiable, auditable history of all economic activity for the $\text{DAO}$.

---

## 11.2 Host Payments

The host payment mechanism ensures that $\text{IPFS}$ nodes are economically incentivized to maintain the availability and redundancy of the content, drawing funds from the **Locked Yield Wallet ($\text{LYW}$)**.

### Proof-of-Storage Verification

Hosts must periodically prove they are reliably storing the content associated with the asset's $\text{CID}$. 

* **Challenge-Response Mechanism:** The smart contract or a decentralized challenger network issues a random challenge (e.g., a cryptographic nonce and a block range within the content's Merkle $\text{DAG}$).
* **Verification:** The host must return a valid Merkle Proof or a cryptographic commitment generated from the challenge and the stored data. Failure to respond correctly or on time results in a penalty to the host's **reputation score**.

### Payment Distribution

Successful Proof-of-Storage verification triggers payment from the $\text{LYW}$:

* **Micro-Payments:** Compensation is delivered as **atomic $\text{sats}$ micro-payments** over the Lightning Network, minimizing transaction fees.
* **Dynamic Rate:** The payment rate is dynamically adjusted based on the current network demand for storage and the asset's current $\text{LYW}$ balance, ensuring the rate is high enough to attract pins but low enough to maximize the asset's lifespan.

---

## 11.3 DAO Governance

The smart contract serves as the executive engine for the $\text{Per-Content DAO}$, translating verified votes into state changes, effectively implementing the governance rules defined in Section 10.3.

### Proposal Lifecycle

Proposals follow a strict, multi-stage lifecycle, enforced by the contract:

1.  **Submission:** A member with sufficient stake (above the proposal_threshold) submits a proposal.
2.  **Voting Period:** Open for voting for the **`voting\_period\_blocks`**.
3.  **Verification:** The contract checks if the vote meets both the **`approval\_quorum`** (participation) and the **`approval\_threshold`** (majority).

### Voting Mechanism

* **Stake Weighting:** Votes are weighted according to the member's current fractionalized $\text{sats}$ stake in the asset.
* **Signature Verification:** Members cast their votes by cryptographically signing a message related to the proposal's hash. The contract verifies the signatures against the member list and their current stake.

### Execution Rules

Execution is the final, irreversible step where the $\text{DAO}$'s decision is enacted:

* **Atomic Execution:** If the vote passes, the smart contract automatically executes the designated function (from the allowed_actions list) against the mutable state.
* **Immutable State Update:** Execution results in the creation of a new, immutable mutable_state_cid (e.g., a new license link or a new royalty split structure), which the Core Content Object is then configured to use for future operations.

---

## 11.4 Economic Recovery and Reset üîÑ

The smart contract is programmed with a clear, automated recovery path to transition the $\text{DAO}$ from a state of incurred debt (and pending sunset) back to a sustainable, income-generating status.

### Recovery Logic and State Transitions

This sequence is triggered upon any income event that raises the assets.LYW_balance_sats above the total outstanding debt.

1.  **Atomic Debt Settlement:**
    * **Priority Payment:** The smart contract immediately and atomically allocates funds from the incoming revenue stream to settle the debts.total_capital_owed_sats recorded in the Accounting Ledger (Section 10.5).
    * **Expense Payout:** The corresponding expenses ($\text{hosting}$, $\text{royalty}$, $\text{creator}$) are simultaneously paid out over the $\text{Lightning}$ Network, and the $\text{debts}$ field is reset to zero.

2.  **Sunset Trigger Reset:**
    * Immediately after debt settlement, the internal block counter monitoring the duration_blocks for the sunset_condition is reset to zero. This effectively **pauses the sunset countdown**, giving the $\text{DAO}$ a fresh economic opportunity.

3.  **Liquidity Leasing and Income Restart:**
    * **Restart Threshold:** The contract checks if the post-settlement $\text{LYW}$ balance is above a predefined minimum operational threshold (e.g., sufficient to cover one month of projected hosting fees).
    * **Liquidity Leasing Re-engagement:** If the threshold is met, the contract re-commits a portion of the $\text{LYW}$ to the $\text{Lightning Liquidity Leasing}$ mechanism. This restarts the generation of passive income, actively rebuilding the $\text{DAO}$'s financial buffer.
